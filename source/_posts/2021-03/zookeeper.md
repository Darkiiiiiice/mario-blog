---
title: Zookeeper
date: '2021-03-15 20:00:00'
category: Zookeeper
author: MarioMang
cover: /resources/images/default_cover.gif
updated: '2021-03-15 20:00:00'
---

## Zookeeper

### 简介

Zookeeper可以在分布式系统中协作多个任务, 一个协作任务是指一个包含多个进程的任务

#### 主从应用

一个主从架构中, 主节点服务器负责跟踪从节点状态和任务的有效性, 并分配任务到从节点

要实现主从模式的系统, 我们必须解决以下三个关键问题

* 主节点崩溃, 如果主节点发送错误并失效, 系统将无法分配新的任务或重新分配已失败的任务
* 从节点崩溃, 如果从节点崩溃, 已分配的任务将无法完成
* 通信故障, 如果主节点和从节点间无法进行信息交换, 从节点将无法得知新任务分配给它

##### 主节点失效

当主节点失效时, 备份节点接管主要主节点的角色, 进行故障转移, 新的主节点需要能够恢复到旧的主节点崩溃时的状态

##### 从节点失效

当从节点失效时, 所有已派发给这个从节点且尚未完成的任务需要重新派发

##### 通信故障

如果从节点与主节点的网络连接断开, 重新分配一个任务可能会导致两个从节点执行相同的任务

#### 分布式协作的难点

CAP定律, 表示一致性(Consistency), 可用性(Availability)和分区容错性(Partition-tolerance), 该定律指出, 当设计一个分布式系统时, 我们希望这三中属性全不满足, 但没有系统可以同时满足这三种属性

因此ZooKeeper的设计尽可能满足一致性和可用性, 当然, 在发生网络分区时ZooKeeper也提供了只读能力

### ZooKeeper基础

ZooKeeper并不知接暴露原语, 取而代之, 它暴露了由一小部分调用方法组成的类似文件系统的API, 以便允许应用实现自己的原语

ZooKeeper操作和维护了一个小型的数据节点, 这些节点称为znode, 采用类似于文件系统的层级树状结构进行管理

#### ZooKeeper基础

##### API概述

znode节点可能包含数据, 也可能不包含数据, 如果一个znode节点包含任何数据, 那么数据存储为字节数组(byte array).

ZooKeeper 的API暴露了以下方法:

* create /path data
  创建一个名为/path 的znode节点, 并包含数据 data

* delete /path
  删除名为/path的znode

* exists /path
  检查是否存在名为/path的节点

* setData /path data
  设置名为/path的znode的数据为data

* getData /path
  返回名为/path节点的数据信息

* getChildren /path
  返回所有/path节点的所有子节点列表

##### znode的不同类型

当新建znode时, 还需要指定该节点的类型, 不同的类型决定了znode节点的行为方式

* 持久节点 只能通过调用delete来进行删除
* 临时节点 当创建该节点的客户端崩溃或关闭了与ZooKeeper的连接时, 这个节点就会被删除
* 有序节点 一个有序znode节点被分配唯一一个单调递增的整数, 当创建有序节点时, 一个序号会被追加到路径之后

##### 监视与通知

ZooKeeper通常以远程服务的方式被访问, 如果每次访问znode时, 客户端都需要获得节点中的内容, 这样的代价就非常大

客户端向ZooKeeper注册需要接收通知的znode, 通过对znode设置监视点(watch)来接收通知, 监视点是一个单次触发的操作, 意即监视点会触发一个通知, 为了接收多个通知, 客户端必须在每次通知后设置一个新的监视点

##### 版本

每一个znode都有一个版本号, 它随着每次数据变化而自增, 两个API操作可以有条件的执行: setData和delete
这两个调用以版本号作为传入参数 只有当传入参数的版本号与服务器上的版本号一致时调用才会成功

#### ZooKeeper 架构

ZooKeeper服务器端运行于两种模式下: 

* 独立模式 
  有一个单独的服务器, ZooKeeper状态无法复制
* 仲裁模式
  仲裁模式, 具有一组ZooKeeper服务器, 他们之间可以进行状态的复制, 并同时为服务于客户端的请求

##### 会话的状态和生命周期

一个会话的主要状态是 NOT_CONNECTED, CONNECTING, CONNECTED, CLOSED





